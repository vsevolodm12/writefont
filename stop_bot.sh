#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞

cd "$(dirname "$0")"

if [ ! -f "bot.pid" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª bot.pid –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë–æ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–ø—É—â–µ–Ω."
    exit 0
fi

PID=$(cat bot.pid)

if [ -z "$PID" ]; then
    echo "‚ö†Ô∏è  PID —Ñ–∞–π–ª –ø—É—Å—Ç"
    rm bot.pid
    exit 0
fi

if ! ps -p $PID > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–¥–∞–ª—è—é bot.pid"
    rm bot.pid
    exit 0
fi

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ (PID: $PID)..."

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
kill -TERM $PID 2>/dev/null || kill $PID

# –ñ–¥–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥
for i in {1..10}; do
    if ! ps -p $PID > /dev/null 2>&1; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        rm bot.pid
        exit 0
    fi
    sleep 1
done

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —É–±–∏–≤–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
if ps -p $PID > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
    kill -9 $PID
    sleep 1
    
    if ! ps -p $PID > /dev/null 2>&1; then
        echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
        rm bot.pid
        exit 0
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç"
        exit 1
    fi
fi

rm bot.pid

